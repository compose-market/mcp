name: Sync MCP Registry Daily

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-registry:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout mcp repository
        uses: actions/checkout@v4
        with:
          repository: compose-market/mcp
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Checkout sync script from main repo
        uses: actions/checkout@v4
        with:
          repository: compose-market/compose-market
          path: compose-market
          sparse-checkout: |
            backend/services/connector/scripts/sync.ts
            backend/services/connector/package.json
      
      - name: Install dependencies
        run: |
          cd compose-market/backend/services/connector
          npm install --legacy-peer-deps
      
      - name: Run registry sync
        run: |
          cd compose-market/backend/services/connector
          npx tsx scripts/sync.ts
      
      - name: Copy updated registry to mcp repo
        run: |
          cp compose-market/backend/mcp/src/data/mcpServers.json src/data/mcpServers.json
      
      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet src/data/mcpServers.json || echo "has_changes=true" >> $GITHUB_OUTPUT
      
      - name: Commit and push if changed
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/data/mcpServers.json
          
          # Count new servers
          NEW_COUNT=$(jq '.count' src/data/mcpServers.json)
          
          git commit -m "Update MCP registry: $NEW_COUNT total servers"
          git push
      
      - name: Trigger containerization for new servers
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Get list of new containerizable servers
            const fs = require('fs');
            const registry = JSON.parse(fs.readFileSync('src/data/mcpServers.json', 'utf8'));
            
            const newServers = registry.servers.filter(s => 
              !s.image && 
              s.transport !== 'http' && 
              !s.remoteUrl &&
              (s.repository?.url || (s.packages && s.packages.length > 0))
            );
            
            console.log(`Found ${newServers.length} servers needing containerization`);
            
            // Only trigger if there are new containerizable servers
            if (newServers.length > 0) {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: 'mcp',
                workflow_id: 'build-mcp-containers.yml',
                ref: 'main',
                inputs: {
                  concurrency: '10',
                  batch_size: '100',
                  filter: ''
                }
              });
              console.log('Triggered containerization workflow');
            }
